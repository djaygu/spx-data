# Story 1.1: Project Setup and Core Architecture

## Status
Draft

## Story
**As a** developer,
**I want** to establish the Effect-TS project structure with proper service layers,
**so that** I have a solid foundation for building the data pipeline.

## Acceptance Criteria
1. Initialize TypeScript project with strict mode, Bun runtime, and Effect-TS dependencies
2. Create project structure with clear separation: /src/services, /src/cli, /src/models, /src/layers
3. Implement base service layer architecture with Context.Tag pattern
4. Set up Effect test framework with example service and test layer using Bun test runner
5. Configure Bun build system to produce single executable binary
6. Create basic Effect Config service for environment variables
7. Implement "health check" CLI command that verifies Effect runtime and Terminal connection

## Tasks / Subtasks
- [ ] Task 1: Initialize Project and Dependencies (AC: 1)
  - [ ] Create new TypeScript project with package.json
  - [ ] Install Bun runtime dependencies: `bun add @effect/platform-bun@0.36.0`
  - [ ] Install Effect-TS core packages: `bun add effect@2.4.0 @effect/cli@0.36.0 @effect/platform@0.36.0 @effect/schema@0.64.0`
  - [ ] Install dev dependencies: `bun add -d @effect/vitest@0.5.0 vitest@1.3.0 typescript@5.3.3 @types/bun@1.0.8`
  - [ ] Create tsconfig.json with strict mode enabled
  - [ ] Create bunfig.toml for Bun configuration
  - [ ] Create vitest.config.ts for test configuration
  
- [ ] Task 2: Create Project Structure (AC: 2)
  - [ ] Create source tree directories as per architecture/source-tree.md
  - [ ] Create src/models/, src/schemas/, src/types/, src/config/ directories
  - [ ] Create src/services/, src/repositories/, src/layers/ directories
  - [ ] Create src/cli/commands/, src/cli/utils/ directories
  - [ ] Create src/utils/, test/, scripts/, data/ directories
  - [ ] Add index.ts files for re-exports in each directory
  - [ ] Create .gitignore to exclude data/ and node_modules/
  
- [ ] Task 3: Implement Base Service Architecture (AC: 3)
  - [ ] Create src/services/ThetaDataApiClient.ts with Context.Tag definition
  - [ ] Create src/services/StatusService.ts interface with Context.Tag
  - [ ] Create src/services/InventoryService.ts interface with Context.Tag
  - [ ] Create src/types/errors.ts with tagged error classes (ApiConnectionError, ValidationError)
  - [ ] Create src/types/common.ts with shared enums and utility types
  
- [ ] Task 4: Set Up Test Framework (AC: 4)
  - [ ] Create test/services/ThetaDataApiClient.test.ts with example test
  - [ ] Create src/layers/TestLive.ts with test environment layer composition
  - [ ] Implement test layer for ThetaDataApiClient with mocked responses
  - [ ] Configure test environment as per test-strategy-and-standards.md
  - [ ] Verify tests run with `bun test` command
  
- [ ] Task 5: Configure Build System (AC: 5)
  - [ ] Create scripts/build.ts for Bun bundler configuration
  - [ ] Configure single binary output to dist/spx-data
  - [ ] Test build process produces executable binary
  - [ ] Add build script to package.json scripts section
  
- [ ] Task 6: Create Effect Config Service (AC: 6)
  - [ ] Create src/config/AppConfig.ts using Effect Config module
  - [ ] Define configuration schema with @effect/schema
  - [ ] Support CONFIG_ prefixed environment variables
  - [ ] Add configuration for: thetaData.baseUrl, download.maxDTE, storage.dataDirectory
  - [ ] Create .env.example with sample configuration
  
- [ ] Task 7: Implement Health Check Command (AC: 7)
  - [ ] Create src/cli/main.ts as CLI entry point using @effect/cli
  - [ ] Create src/cli/commands/health.ts command implementation
  - [ ] Implement ThetaData Terminal connection check to http://127.0.0.1:25510
  - [ ] Add Effect runtime verification
  - [ ] Format output with success/failure messages
  - [ ] Create src/main.ts as application entry point
  - [ ] Test command with `bun run src/main.ts health`

## Dev Notes

### Previous Story Insights
No previous story exists - this is the first story of the project.

### Data Models
No specific data models needed for this story. Focus is on project setup and infrastructure.

### API Specifications
ThetaData Terminal base URL: http://127.0.0.1:25510 [Source: architecture/external-apis.md#base-urls]
Health check endpoint: /v2/system/mdds/status [Source: architecture/external-apis.md#integration-notes]

### Component Specifications
No UI components - CLI-only application.

### File Locations
Based on architecture/source-tree.md:
- Service interfaces: src/services/
- Service implementations: src/layers/
- CLI commands: src/cli/commands/
- Configuration: src/config/
- Types and errors: src/types/
- Tests: test/ (mirroring src structure)

### Testing Requirements
- Test framework: @effect/vitest 0.5.0 [Source: architecture/test-strategy-and-standards.md#unit-tests]
- Test file convention: {module}.test.ts in /test directory
- Use Effect Test layers for mocking (no external mocking needed)
- Follow AAA pattern (Arrange, Act, Assert)
- Automatic cleanup using Effect.addFinalizer

### Technical Constraints
- Runtime: Bun 1.1.0 [Source: architecture/tech-stack.md#technology-stack-table]
- Language: TypeScript 5.3.3 with strict mode
- All Effect services must have Test implementations [Source: architecture/coding-standards.md#critical-rules]
- Never use console.log - use Effect.log instead
- Service interfaces must use Context.Tag pattern
- All async operations must use Effect.tryPromise

### Testing
**Testing Standards from Architecture:**
- Test Location: /test directory mirroring /src structure [Source: architecture/test-strategy-and-standards.md#unit-tests]
- Test Framework: @effect/vitest 0.5.0 with Bun test runner
- Test Pattern: Strict TDD - Red, Green, Refactor approach
- Test Layers: Create TestEnvironmentLive layer composition as shown in architecture
- Coverage Goal: 90% for services, 80% for utilities
- Mock Strategy: Use Effect Test layers, no external mocking libraries needed

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-05 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results