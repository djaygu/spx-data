# Story 1.6: Integration Tests and Documentation

**Story ID**: 1.6  
**Epic**: Epic 1 - Foundation & Streaming Pipeline  
**Status**: In Progress  
**Priority**: High  
**Estimated Effort**: 1 day (focused on gaps only)  
**Created**: 2025-08-08  
**Approved**: 2025-08-08 by Sarah (PO)  

## User Story

**As a** developer,  
**I want** comprehensive error handling tests and missing documentation,  
**So that** the system handles edge cases properly and is fully documented.

## Story Context

**Existing System Integration:**
- Integrates with: All Epic 1 services (ThetaDataApiClient, BulkGreeksProcessor, DataPipeline, CLI commands)
- Technology: Bun test framework, Effect-TS test utilities, Markdown documentation
- Follows pattern: Existing test patterns from unit and integration tests
- Touch points: All service boundaries and CLI entry points

## Acceptance Criteria

**Functional Requirements:**
1. Create end-to-end test that downloads real data for a sample date
2. Add integration tests for error propagation, concurrency limits, and stream cleanup
3. Enhance README with detailed ThetaData Terminal setup, Java requirements, and startup process
4. Include troubleshooting guide for common issues
5. Verify single binary deployment works on clean system without dependencies

**Integration Requirements:**
6. Existing test suite continues to pass without regression
7. New tests follow existing test patterns and directory structure
8. Integration tests properly isolate with TestLive layers

**Quality Requirements:**
9. Test coverage reaches 80% or higher for core services
10. Documentation is clear and accurate with working examples

## Technical Implementation Tasks

### Task 1: End-to-End Test Implementation (AC: 1)
- [ ] Create `test/e2e/download-full-day.test.ts`
- [ ] Setup test with real ThetaData Terminal connection (skip if not available)
- [ ] Test downloading actual SPX data for a known good date
- [ ] Verify output file structure and CSV format correctness
- [ ] Validate record counts and data integrity
- [ ] Add timeout handling for long-running test
- [ ] Mark test with `@integration` tag for conditional execution

### Task 2: Service Error & Edge Case Integration Tests (AC: 2)
- [ ] Create `test/integration/service-error-handling.test.ts`
- [ ] Test error propagation when ThetaDataApiClient fails mid-stream
- [ ] Test error propagation when BulkGreeksProcessor encounters invalid data
- [ ] Test DataPipeline behavior when CsvDataWriter fails (disk full, permissions)
- [ ] Verify concurrency limits are enforced under load
- [ ] Test backpressure handling when downstream is slower than upstream
- [ ] Validate proper stream cleanup and resource release on SIGINT/SIGTERM
- [ ] Test memory cleanup for long-running streams

### Task 3: Enhanced Terminal Setup Documentation (AC: 3)
- [ ] Add Java 17+ requirement and installation instructions to README
- [ ] Document Terminal download location (https://download-stable.thetadata.us/)
- [ ] Add Terminal startup command: `java -jar ThetaTerminal.jar username password`
- [ ] Document port 25510 for REST API and firewall/proxy considerations
- [ ] Explain difference between REST (port 25510) and WebSocket usage
- [ ] Add Terminal verification steps (health check, connection status)
- [ ] Document environment variable mapping (THETA_DATA_TERMINAL_URL â†’ CONFIG_THETADATA_BASE_URL)
- [ ] Add system requirements (minimum 2GB RAM for Terminal, disk space for data caching)
- [ ] Include Terminal update process and version checking
- [ ] Document Terminal config file location (if exists) and important settings
- [ ] Add note about Terminal's 30x bandwidth reduction and local server architecture
- [ ] Include troubleshooting for common Java/Terminal startup issues

### Task 4: Troubleshooting Guide (AC: 4)
- [ ] Create `docs/TROUBLESHOOTING.md`
- [ ] Document common Terminal connection errors and solutions
- [ ] Add rate limiting errors and mitigation strategies
- [ ] Include file permission problems and resolutions
- [ ] Document memory/performance tuning for large datasets
- [ ] Add WebSocket timeout issues and fixes
- [ ] Include FAQ section with common questions
- [ ] Add debugging tips for Effect-TS fiber issues

### Task 5: Binary Deployment Verification (AC: 5)
- [ ] Build standalone binary using `bun build ./src/cli.ts --compile --outfile spx-data`
- [ ] Test binary on clean Docker container without Bun/Node installed
- [ ] Verify all Effect-TS dependencies are properly bundled in the binary
- [ ] Test on both Linux (Ubuntu, Alpine) and macOS platforms
- [ ] Compare binary size vs current JS bundle (current: ~1-2MB JS file)
- [ ] Document cold start performance (binary vs Bun runtime)
- [ ] Update build.ts script to support --compile flag for binary builds
- [ ] Create deployment script with SHA256 checksum verification
- [ ] Test binary with various system resource limits (ulimit settings)
- [ ] Verify binary handles missing Terminal gracefully with clear error messages
- [ ] Test binary can write to filesystem without Bun runtime permissions

### Task 6: Test Coverage Report (AC: 9)
- [ ] Configure coverage reporting with `bun test --coverage`
- [ ] Generate baseline coverage report for existing tests
- [ ] Identify critical paths with low coverage
- [ ] Add unit tests for uncovered error handling paths
- [ ] Document coverage metrics in README
- [ ] Set up coverage threshold checks (80% minimum)
- [ ] Create coverage badge for repository

### Task 7: Documentation Review and Polish (AC: 10)
- [ ] Review all documentation for technical accuracy
- [ ] Test all code examples in documentation
- [ ] Verify environment variable documentation is complete
- [ ] Ensure Effect-TS patterns are properly explained
- [ ] Add troubleshooting guide link to main README
- [ ] Create documentation index if needed


## Dev Notes

### Test Organization
Following the existing test structure:
- Unit tests: `test/services/*.test.ts`
- Integration tests: `test/integration/*.test.ts`
- E2E tests: `test/e2e/*.test.ts` (new directory)
- Performance tests: `test/performance/*.test.ts` (new directory)

### Test Execution Strategy
- Unit tests: Always run (fast, no external dependencies)
- Integration tests: Run when THETA_DATA_TERMINAL_URL is set
- E2E tests: Run manually or in nightly CI builds
- Performance tests: Run on demand with `bun test:perf`

### Documentation Structure
Current documentation organization:
- `/docs/architecture/` - Technical architecture docs
- `/docs/prd/` - Product requirements
- `/docs/stories/` - User stories
- `/docs/usage-examples/` - Code examples
- `/README.md` - Main project documentation
- `/docs/TROUBLESHOOTING.md` - New troubleshooting guide

### Binary Compilation with Bun
Two build modes available:

**Current (JavaScript bundle - requires Bun runtime):**
```bash
bun run build  # Uses scripts/build.ts, outputs JS file with #!/usr/bin/env bun
```

**Standalone Binary (no Bun runtime needed):**
```bash
bun build ./src/cli.ts --compile --outfile dist/spx-data
```

The compiled binary embeds the Bun runtime and all dependencies (Effect-TS, etc.) creating a self-contained executable that runs on systems without Bun installed.

## Testing

### Test Standards
- Follow TDD approach where practical
- Use descriptive test names that explain the scenario
- Group related tests using describe blocks
- Mock external dependencies with TestLive layers
- Use beforeAll/afterAll for setup/cleanup
- Tag long-running tests appropriately

### Coverage Goals
- Core services: 80% minimum
- CLI commands: 70% minimum
- Utilities: 90% minimum
- Overall project: 75% minimum

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-08 | 1.0 | Initial story creation | Sarah (PO) |

## Definition of Done

- [ ] Functional requirements met (all tests and docs created)
- [ ] Integration requirements verified (tests follow patterns)
- [ ] Existing functionality regression tested
- [ ] Code follows existing test patterns and standards
- [ ] All tests pass (unit, integration, e2e)
- [ ] Documentation reviewed and accurate
- [ ] Coverage goals met (75% overall minimum)
- [ ] Binary deployment verified on target platform

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk:** E2E tests may be flaky due to external dependencies
- **Mitigation:** Proper test isolation and retry logic
- **Rollback:** Tests and docs are additive only, no production impact

**Compatibility Verification:**
- [x] No breaking changes to existing APIs
- [x] Database changes are additive only (N/A)
- [x] UI changes follow existing patterns (N/A)
- [x] Performance impact is negligible (test-only changes)

## Validation Checklist

**Scope Validation:**
- [x] Story can be completed in one development session (1 day)
- [x] Integration approach is straightforward
- [x] Follows existing patterns exactly
- [x] No design or architecture work required

**Clarity Check:**
- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified
- [x] Success criteria are testable
- [x] Rollback approach is simple (remove test files)

---
## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
[To be filled]

### Debug Log References
[To be filled]

### Completion Notes List
[To be filled]

### File List
[To be filled]